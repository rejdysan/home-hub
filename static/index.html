<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home Hub - Live Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --accent: #38bdf8;
            --danger: #ef4444;
        }

        body {
            font-family: system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 20px;
            margin: 0;
        }

        h2 {
            border-bottom: 1px solid #334155;
            padding-bottom: 8px;
            color: #94a3b8;
            font-size: 0.85rem;
            text-transform: uppercase;
            margin: 30px 0 15px 0;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #334155;
            position: relative;
        }

        .label {
            font-size: 0.7rem;
            color: #94a3b8;
            text-transform: uppercase;
            font-weight: 600;
        }

        .value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--accent);
            margin: 5px 0;
        }

        .unit {
            font-size: 1rem;
            color: #64748b;
            font-weight: 400;
        }

        .sys-detail {
            font-size: 0.8rem;
            margin: 8px 0;
            color: #cbd5e1;
        }

        .progress-bg {
            background: #334155;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            background: var(--accent);
            height: 100%;
            transition: width 0.6s ease-out;
        }

        .warning-fill {
            background: var(--danger) !important;
        }

        /* Chart container styling */
        .chart-container {
            height: 250px;
            margin-top: 10px;
            width: 100%;
        }

        #status-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #334155;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>

<div id="status-overlay">
    <div class="spinner"></div>
    <p style="color: var(--danger); margin-top: 15px;">Connecting to Hub...</p>
</div>

<!--<h2>üìà Trend: Main Temperature</h2>-->
<!--<div class="card">-->
<!--    <div class="chart-container">-->
<!--        <canvas id="tempChart"></canvas>-->
<!--    </div>-->
<!--</div>-->

<h2>üå°Ô∏è Environment Sensors</h2>
<div id="temp-grid" class="grid"></div>

<h2>üñ•Ô∏è System Performance</h2>
<div id="sys-grid" class="grid"></div>

<script>
    const tempGrid = document.getElementById('temp-grid');
    const sysGrid = document.getElementById('sys-grid');
    const overlay = document.getElementById('status-overlay');

    let myChart;
    const MAX_POINTS = 20;

    // Initialize Chart.js
    function initChart() {
        const ctx = document.getElementById('tempChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temperature',
                    data: [],
                    borderColor: '#38bdf8',
                    backgroundColor: 'rgba(56, 189, 248, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {legend: {display: false}},
                scales: {
                    y: {grid: {color: '#334155'}, ticks: {color: '#94a3b8'}},
                    x: {grid: {display: false}, ticks: {color: '#94a3b8'}}
                }
            }
        });
    }

    function updateChart(newVal) {
        if (!myChart) return;
        const timeLabel = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'});

        myChart.data.labels.push(timeLabel);
        myChart.data.datasets[0].data.push(newVal);

        if (myChart.data.labels.length > MAX_POINTS) {
            myChart.data.labels.shift();
            myChart.data.datasets[0].data.shift();
        }
        myChart.update('none'); // Update without animation for performance
    }

    function updateSystemCard(id, title, pct, detail, isSpeed = false) {
        let card = document.getElementById(id);
        if (!card) {
            card = document.createElement('div');
            card.id = id;
            card.className = 'card';
            sysGrid.appendChild(card);
        }

        const barHtml = isSpeed ? '' : `
                <div class="progress-bg">
                    <div class="progress-fill ${pct > 85 ? 'warning-fill' : ''}" style="width: ${Math.min(pct, 100)}%"></div>
                </div>
            `;

        card.innerHTML = `
                <div class="label">${title}</div>
                <div class="sys-detail">${detail}</div>
                ${barHtml}
            `;
    }

    function connect() {
        const ws = new WebSocket(`ws://${window.location.host}/ws`);

        ws.onopen = () => {
            overlay.style.display = 'none';
            console.log("‚úÖ Connected");
        };

        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                const sensors = data.sensors || [];
                const sys = data.system || {};

                // 1. Surgical Update: Sensors (No Flickering)
                sensors.forEach(item => {
                    const cardId = `sensor-${item.sensor}-${item.prop}`.replace(/\s+/g, '-');
                    let card = document.getElementById(cardId);

                    if (!card) {
                        card = document.createElement('div');
                        card.id = cardId;
                        card.className = 'card';
                        card.innerHTML = `
                                <div class="label">${item.sensor} ‚Ä¢ ${item.prop}</div>
                                <div class="value"><span class="val-text">--</span><span class="unit">¬∞C</span></div>
                            `;
                        tempGrid.appendChild(card);
                    }

                    const valSpan = card.querySelector('.val-text');
                    valSpan.innerText = (item.temp || 0).toFixed(1);
                });

                // 2. Chart Update (Using first sensor as sample)
                if (sensors.length > 0) {
                    updateChart(sensors[0].temp);
                }

                // 3. Update System Cards
                const cpuTemp = sys.cpu_temp ? sys.cpu_temp.toFixed(1) + '¬∞C' : 'N/A';
                updateSystemCard("cpu-card", "‚ö° CPU Usage", sys.cpu || 0, `Load: ${(sys.cpu || 0).toFixed(1)}% | Temp: ${cpuTemp}`);
                updateSystemCard("ram-card", "üß† Memory", sys.ram_pct || 0, `${sys.ram_used || 0} / ${sys.ram_total || 0} GB Used`);
                updateSystemCard("disk-card", "üíæ Storage", sys.disk_pct || 0, `${sys.disk_used || 0} / ${sys.disk_total || 0} GB Used`);
                updateSystemCard("net-card", "üåê Network", 0, `‚Üì ${sys.net_recv || 0} KB/s | ‚Üë ${sys.net_sent || 0} KB/s`, true);

            } catch (e) {
                console.error("Data Error", e);
            }
        };

        ws.onclose = () => {
            overlay.style.display = 'flex';
            setTimeout(connect, 3000);
        };
    }

    // Initialize Everything
    // initChart();
    connect();
</script>
</body>
</html>